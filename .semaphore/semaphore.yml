version: v1.0
name: Using C in Semaphore 2.0
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804

blocks:
  - name: Zephyr Tests
    task:
      secrets:
        - name: ssh_pub_key
      env_vars:
        - name: ZEPHYR_SDK_INSTALL_DIR
          value: "/opt/toolchains/zephyr-sdk-0.9.5"
        - name: ZEPHYR_TOOLCHAIN_VARIANT
          value: "zephyr"
        - name: DTC
          value: "/opt/toolchains/zephyr-sdk-0.9.5/sysroots/x86_64-pokysdk-linux/usr/bin/dtc"
      jobs:
      - name: sanitycheck
        commands:
          - echo '$my_pub_key' >> .ssh/authorized_keys
          - sem-version c 7
          - checkout
          - sudo ./install.sh
          - sudo apt-get remove python3.4
          - sudo apt-get autoremove
          - sudo pip3 install -r scripts/requirements.txt
          - sudo pip3 install wheel west sh pyelftools==0.24
          - /usr/bin/env python3 -c "import elftools"
          - sudo mkdir -p /usr/local/bin
          - sudo cp /opt/toolchains/zephyr-sdk-0.9.5/sysroots/x86_64-pokysdk-linux/usr/bin/dtc /usr/local/bin
          - source zephyr-env.sh
          - ./scripts/sanitycheck --inline-logs -T samples/synchronization/
