version: v1.0
name: Using C in Semaphore 2.0
agent:
  machine:
    type: e1-standard-8
    os_image: ubuntu1804

blocks:
  - name: Zephyr Tests
    task:
      secrets:
        - name: ssh_pub_key
      env_vars:
        - name: ZEPHYR_SDK_INSTALL_DIR
          value: "/home/semaphore/zephyr-sdk-0.9.5"
        - name: ZEPHYR_TOOLCHAIN_VARIANT
          value: "zephyr"
        - name: USE_CCACHE
          value: "1"
      jobs:
      - name: sanitycheck
        commands:
          - export CCACHE_DIR=$HOME/.ccache
          - cache restore zephyr_sdk
          - cache restore ccache_dir
          - sem-version c 7
          - checkout
          - sudo ./install.sh
          - cache store zephyr_sdk $ZEPHYR_SDK_INSTALL_DIR
          - ccache -s
          - sudo mkdir -p /usr/local/bin
          - sudo cp $HOME/zephyr-sdk-0.9.5/sysroots/x86_64-pokysdk-linux/usr/bin/dtc /usr/local/bin
          - source zephyr-env.sh
          - ./scripts/sanitycheck --inline-logs -N --subset 1/5 -T tests/kernel
          - ccache -s
          - cache store ccache_dir $CCACHE_DIR
